## –°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

![–°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö](database-schema.png)

### ER-–¥–∏–∞–≥—Ä–∞–º–º–∞

–°—Ö–µ–º–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Å —Å–æ–±–ª—é–¥–µ–Ω–∏–µ–º –ø—Ä–∏–Ω—Ü–∏–ø–æ–≤ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å—é –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Filmorate.

#### –û—Å–Ω–æ–≤–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏:

**üé¨ FILMS** - –∫–∞—Ç–∞–ª–æ–≥ —Ñ–∏–ª—å–º–æ–≤
- `id` - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ñ–∏–ª—å–º–∞
- `name` - –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–∏–ª—å–º–∞
- `description` - –æ–ø–∏—Å–∞–Ω–∏–µ (–º–∞–∫—Å–∏–º—É–º 200 —Å–∏–º–≤–æ–ª–æ–≤)
- `release_date` - –¥–∞—Ç–∞ —Ä–µ–ª–∏–∑–∞ (–Ω–µ —Ä–∞–Ω–µ–µ 28.12.1895)
- `duration` - –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ –º–∏–Ω—É—Ç–∞—Ö (–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ)
- `mpa_id` - —Å—Å—ã–ª–∫–∞ –Ω–∞ —Ä–µ–π—Ç–∏–Ω–≥ MPA (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ)

**üë• USERS** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–∏—Å—Ç–µ–º—ã
- `id` - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `email` - —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞ (—É–Ω–∏–∫–∞–ª—å–Ω–∞—è, –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è)
- `login` - –ª–æ–≥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π, –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤)
- `name` - –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è login)
- `birthday` - –¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è (–Ω–µ –≤ –±—É–¥—É—â–µ–º)

**üè∑Ô∏è MPA** - –≤–æ–∑—Ä–∞—Å—Ç–Ω—ã–µ —Ä–µ–π—Ç–∏–Ω–≥–∏ Motion Picture Association
- `id` - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
- `name` - –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–µ–π—Ç–∏–Ω–≥–∞
  - **G** - –Ω–µ—Ç –≤–æ–∑—Ä–∞—Å—Ç–Ω—ã—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
  - **PG** - –¥–µ—Ç—è–º —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–º–æ—Ç—Ä–µ—Ç—å —Å —Ä–æ–¥–∏—Ç–µ–ª—è–º–∏
  - **PG-13** - –¥–µ—Ç—è–º –¥–æ 13 –ª–µ—Ç –ø—Ä–æ—Å–º–æ—Ç—Ä –Ω–µ –∂–µ–ª–∞—Ç–µ–ª–µ–Ω
  - **R** - –ª–∏—Ü–∞–º –¥–æ 17 –ª–µ—Ç —Ç–æ–ª—å–∫–æ –≤ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–∏ –≤–∑—Ä–æ—Å–ª–æ–≥–æ
  - **NC-17** - –ª–∏—Ü–∞–º –¥–æ 18 –ª–µ—Ç –ø—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–ø—Ä–µ—â—ë–Ω

**üé≠ GENRES** - –∂–∞–Ω—Ä—ã —Ñ–∏–ª—å–º–æ–≤
- `id` - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
- `name` - –Ω–∞–∑–≤–∞–Ω–∏–µ –∂–∞–Ω—Ä–∞ (–ö–æ–º–µ–¥–∏—è, –î—Ä–∞–º–∞, –ú—É–ª—å—Ç—Ñ–∏–ª—å–º, –¢—Ä–∏–ª–ª–µ—Ä, –î–æ–∫—É–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π, –ë–æ–µ–≤–∏–∫)

#### –°–≤—è–∑—É—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã:

**ü§ù FRIENDSHIPS** - –¥—Ä—É–∂–±–∞ –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- `user_id` - –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä –¥—Ä—É–∂–±—ã
- `friend_id` - –ø–æ–ª—É—á–∞—Ç–µ–ª—å –∑–∞–ø—Ä–æ—Å–∞
- `confirmed` - —Å—Ç–∞—Ç—É—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (true/false)
  - `false` - –Ω–µ–ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω–∞—è –¥—Ä—É–∂–±–∞ (–æ–¥–∏–Ω –æ—Ç–ø—Ä–∞–≤–∏–ª –∑–∞–ø—Ä–æ—Å)
  - `true` - –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω–∞—è –¥—Ä—É–∂–±–∞ (–æ–±–∞ —Å–æ–≥–ª–∞—Å–∏–ª–∏—Å—å)

**‚ù§Ô∏è FILM_LIKES** - –ª–∞–π–∫–∏ —Ñ–∏–ª—å–º–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- `film_id` - —Å—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–∏–ª—å–º
- `user_id` - —Å—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**üîó FILM_GENRES** - —Å–≤—è–∑—å —Ñ–∏–ª—å–º–æ–≤ –∏ –∂–∞–Ω—Ä–æ–≤ (–º–Ω–æ–≥–∏–µ –∫–æ –º–Ω–æ–≥–∏–º)
- `film_id` - —Å—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–∏–ª—å–º
- `genre_id` - —Å—Å—ã–ª–∫–∞ –Ω–∞ –∂–∞–Ω—Ä

#### –ü—Ä–∏–Ω—Ü–∏–ø—ã –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:

1. **–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è**: –í—Å–µ —Ç–∞–±–ª–∏—Ü—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —Ç—Ä–µ—Ç—å–µ–π –Ω–æ—Ä–º–∞–ª—å–Ω–æ–π —Ñ–æ—Ä–º–µ (3–ù–§)
2. **–¶–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö**: –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
3. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –°–æ–∑–¥–∞–Ω—ã –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
4. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**: –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –ø–æ–ª—è –∏ —Å–≤—è–∑–∏

### –ü—Ä–∏–º–µ—Ä—ã –æ—Å–Ω–æ–≤–Ω—ã—Ö SQL –∑–∞–ø—Ä–æ—Å–æ–≤

#### –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–ø N –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ñ–∏–ª—å–º–æ–≤
```sql
SELECT f.id, f.name, f.description, f.release_date, f.duration,
       m.name as mpa_name,
       COUNT(fl.user_id) as likes_count
FROM films f
LEFT JOIN mpa m ON f.mpa_id = m.id
LEFT JOIN film_likes fl ON f.id = fl.film_id
GROUP BY f.id, f.name, f.description, f.release_date, f.duration, m.name
ORDER BY likes_count DESC, f.id
LIMIT ?;
```

#### –ü–æ–ª—É—á–µ–Ω–∏–µ —Ñ–∏–ª—å–º–∞ —Å –∂–∞–Ω—Ä–∞–º–∏
```sql
SELECT f.id, f.name, f.description, f.release_date, f.duration,
       m.name as mpa_name,
       STRING_AGG(g.name, ', ') as genres
FROM films f
LEFT JOIN mpa m ON f.mpa_id = m.id
LEFT JOIN film_genres fg ON f.id = fg.film_id
LEFT JOIN genres g ON fg.genre_id = g.id
WHERE f.id = ?
GROUP BY f.id, f.name, f.description, f.release_date, f.duration, m.name;
```

#### –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±—â–∏—Ö –¥—Ä—É–∑–µ–π –¥–≤—É—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
```sql
SELECT u.id, u.email, u.login, u.name, u.birthday
FROM users u
WHERE u.id IN (
    SELECT f1.friend_id
    FROM friendships f1
    JOIN friendships f2 ON f1.friend_id = f2.friend_id
    WHERE f1.user_id = ? AND f2.user_id = ? 
    AND f1.confirmed = true AND f2.confirmed = true
)
ORDER BY u.id;
```

#### –ü–æ–ª—É—á–µ–Ω–∏–µ –¥—Ä—É–∑–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```sql
SELECT u.id, u.email, u.login, u.name, u.birthday
FROM users u
JOIN friendships f ON u.id = f.friend_id
WHERE f.user_id = ? AND f.confirmed = true
ORDER BY u.id;
```

#### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª–∞–π–∫–∞ —Ñ–∏–ª—å–º—É
```sql
INSERT INTO film_likes (film_id, user_id) VALUES (?, ?);
```

#### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–∏–ª—å–º–∞ —Å –∂–∞–Ω—Ä–∞–º–∏
```sql
-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–∏–ª—å–º–∞
INSERT INTO films (name, description, release_date, duration, mpa_id)
VALUES (?, ?, ?, ?, ?)
RETURNING id;

-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∂–∞–Ω—Ä–æ–≤ –∫ —Ñ–∏–ª—å–º—É
INSERT INTO film_genres (film_id, genre_id) VALUES (?, ?);
```